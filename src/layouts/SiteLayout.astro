---
import { getRelativeLocaleUrl } from 'astro:i18n';
import { useTranslations } from '../i18n/utils';
import "../styles/global.css";

interface Props {
  title?: string;
  lang?: string;
}

const { title = "Obtego — Making Healthcare Engaging", lang = "en" } = Astro.props;

const currentLocale = Astro.currentLocale || "en";
const homeURLEn = getRelativeLocaleUrl("en");
const homeURLZhHans = getRelativeLocaleUrl("zh-hans");

const localeNames: Record<string, string> = {
  "en": "English",
  "zh-hans": "中文"
};

const t = useTranslations(lang as "en" | "zh-hans");
---

<!DOCTYPE html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Lora:ital,wght@0,400..700;1,400..700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <!-- Navigation -->
    <nav id="nav">
      <a href={currentLocale === "en" ? "/" : `/${currentLocale}/`} class="logo">
        <img src="/img/obtego-logomark.svg" alt="" />
        <span>obtego</span>
      </a>
      <div style="display: flex; align-items: center; gap: 1rem;">
        <!-- Locale Dropdown -->
        <div class="locale-dropdown">
          <button
            id="locale-dropdown-button"
            class="locale-dropdown-button"
            aria-expanded="false"
            aria-haspopup="true"
          >
            <span>{localeNames[currentLocale]}</span>
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div
            id="locale-dropdown-menu"
            class="locale-dropdown-menu"
            role="menu"
            aria-orientation="vertical"
          >
            <a
              href={homeURLEn}
              role="menuitem"
              class={currentLocale === "en" ? "active" : ""}
            >
              English
            </a>
            <a
              href={homeURLZhHans}
              role="menuitem"
              class={currentLocale === "zh-hans" ? "active" : ""}
            >
              中文
            </a>
          </div>
        </div>
        <a href="#signup" class="btn-primary nav-cta">{t("nav.signup")}</a>
      </div>
    </nav>

    <slot />

    <script>
      // Nav scroll effect
      const nav = document.getElementById("nav");
      if (nav) {
        window.addEventListener("scroll", () => {
          if (window.scrollY > 50) {
            nav.classList.add("scrolled");
          } else {
            nav.classList.remove("scrolled");
          }
        });
      }

      // Locale Dropdown
      function initLocaleDropdown() {
        const dropdownButton = document.getElementById("locale-dropdown-button");
        const dropdownMenu = document.getElementById("locale-dropdown-menu");

        if (!dropdownButton || !dropdownMenu) return;

        function openDropdown() {
          dropdownMenu!.classList.add("open");
          dropdownButton!.setAttribute("aria-expanded", "true");
        }

        function closeDropdown() {
          dropdownMenu!.classList.remove("open");
          dropdownButton!.setAttribute("aria-expanded", "false");
        }

        function toggleDropdown() {
          const isOpen = dropdownMenu!.classList.contains("open");
          if (isOpen) {
            closeDropdown();
          } else {
            openDropdown();
          }
        }

        dropdownButton.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          toggleDropdown();
        });

        document.addEventListener("click", (e) => {
          if (
            !dropdownButton.contains(e.target as Node) &&
            !dropdownMenu.contains(e.target as Node)
          ) {
            closeDropdown();
          }
        });

        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            closeDropdown();
          }
        });
      }

      document.addEventListener("DOMContentLoaded", initLocaleDropdown);
    </script>
  </body>
</html>

