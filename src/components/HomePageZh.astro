---
// HomePage component - renders all page sections
// Content is English by default; translations can be handled via props or i18n later
---

<!-- Hero -->
<section class="hero">
  <div class="hero-content">
    <div class="hero-text">
      <h1>你的健康，<em>终于</em>看得懂了</h1>
      <p class="hero-subtitle">
        我们将出院小结、化验结果和病历资料，转化为清晰易懂、可探索的内容——用明确的总结、直观的视觉解释，以及在你需要时随时可得的答案，帮助你真正理解自己的健康。
      </p>
      <div class="hero-cta-group">
        <a href="#signup" class="btn-primary">加入等候名单</a>
        <a href="#" class="btn-secondary" id="videoModalTrigger">
          <svg
            width="16"
            height="16"
            viewBox="0 0 16 16"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M6 4L12 8L6 12V4Z"
              fill="currentColor"
              stroke="currentColor"
              stroke-width="1"
              stroke-linejoin="round"
            />
          </svg>
          查看 2 分钟演示
        </a>
      </div>
    </div>
    <div class="hero-image-wrapper">
      <img
        src="/img/icons-lg/icon-schedule.png"
        alt="Obtego schedule icon"
        class="hero-icon hero-icon-schedule"
      />
      <img
        src="/img/icons-lg/icon-meds.png"
        alt="Obtego meds icon"
        class="hero-icon hero-icon-meds"
      />
      <img
        src="/img/icons-lg/icon-alerts.png"
        alt="Obtego alerts icon"
        class="hero-icon hero-icon-alerts"
      />
      <img
        src="/img/robot-3d-pointing.png"
        alt="Obtego robot character"
        class="hero-image"
      />
    </div>
  </div>
</section>

<!-- Problem -->
<section class="problem">
  <div class="problem-inner fade-in">
    <span class="section-label">问题所在</span>
    <h2>
      过时的医疗沟通方式，让你被困在“信息与理解”的夹缝中
    </h2>
    <p class="problem-text">拥有医疗信息，并不等于真正理解它对你意味着什么。无论你是在管理自己的健康，还是帮助家人应对疾病，你都是医疗过程中的积极参与者。但现实是：医生给你的文件往往冗长、充满拉丁医学术语，几乎无法阅读，更谈不上理解。
    </p>

    <div class="document-mockup">
      <div class="before-after-slider">
        <div class="slider-container">
          <img
            src="/img/report-before.png"
            alt="After: Transformed document"
            class="slider-image slider-before"
          />
          <img
            src="/img/report-after.png"
            alt="Before: Medical document"
            class="slider-image slider-after"
          />
          <div class="slider-handle" id="sliderHandle">
            <div class="slider-handle-line"></div>
            <div class="slider-handle-circle">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M8 9L12 5L16 9M8 15L12 19L16 15"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </div>
          </div>
          <div class="slider-label slider-label-before">之后</div>
          <div class="slider-label slider-label-after">之前</div>
        </div>
      </div>
    </div>

    <div class="document-mockup-mobile">
      <div class="mobile-slider-item">
        <div class="mobile-slider-label">之前：关键信息被埋没</div>
        <img
          src="/img/report-before.png"
          alt="Before: Medical document"
          class="mobile-slider-image"
        />
      </div>
      <div class="mobile-slider-item">
        <div class="mobile-slider-label">之后：一目了然、真正看得懂</div>
        <img
          src="/img/report-after.png"
          alt="After: Transformed document"
          class="mobile-slider-image"
        />
      </div>
    </div>
  </div>
</section>

<!-- Solution -->
<section class="solution" id="how">
  <div class="solution-header fade-in">
    <span class="section-label">更好的方式</span>
    <h2>把医疗文件，变成“人能理解的健康故事”</h2>
    <p class="solution-subtitle">
      Obtego 将你的医疗记录，转化为由你掌控、易于理解和探索的内容。
    </p>
  </div>

  <div class="features">
    <div class="feature-card fade-in">
      <div class="feature-icon">
        <img src="/img/icon-clipboard.png" alt="Clipboard icon" />
      </div>
      <h3>交互式摘要</h3>
      <p>
        我们从密集复杂的医疗文档中提取关键信息，让你立刻明白医生发现了什么，以及你接下来该做什么。
      </p>
    </div>

    <div class="feature-card fade-in">
      <div class="feature-icon">
        <img src="/img/icon-magnifier.png" alt="Magnifier icon" />
      </div>
      <h3>按需深入</h3>
      <p>
        先从简明摘要开始。轻点任何高亮内容——诊断、药物或生命体征——即可展开查看 3D 可视化、趋势图表和通俗易懂的解释。
      </p>
    </div>

    <div class="feature-card fade-in">
      <div class="feature-icon">
        <img src="/img/icon-speech.png" alt="Speech icon" />
      </div>
      <h3>即时获得答案</h3>
      <p>
        对病历有疑问？通过文字或语音提问，获取基于你真实健康数据的清晰解释。
      </p>
    </div>

    <div class="feature-card fade-in">
      <div class="feature-icon">
        <img src="/img/icon-checkbox.png" alt="Checkbox icon" />
      </div>
      <h3>清晰的随访提醒</h3>
      <p>
        所有随访事项和“需要留意的情况”都会被集中展示在最显眼的位置，先看到最重要的，避免遗漏。
      </p>
    </div>

    <div class="feature-card fade-in">
      <div class="feature-icon">
        <img src="/img/icon-scissors.png" alt="Scissors icon" />
      </div>
      <h3>给医生的 Snips（问题摘记）</h3>
      <p>
        在家想到问题，却在看诊时忘了问？用 Snips 保存并整理问题，随时可用。
      </p>
    </div>

    <div class="feature-card fade-in">
      <div class="feature-icon">
        <img src="/img/icon-handshake.png" alt="Handshake icon" />
      </div>
      <h3>更好的医患对话</h3>
      <p>
        每次就诊前，你的问题已整理好、关切已记录清楚，你拥有足够的背景信息，去进行一次真正有意义的医疗沟通。
      </p>
    </div>
  </div>
</section>

<!-- Philosophy -->
<section class="philosophy">
  <div class="philosophy-inner fade-in">
    <blockquote>
      “当你理解自己身体里正在发生什么，就不再只是被动地坐在医疗旅程的副驾驶位上。”
    </blockquote>
    <p>
      我们相信，真正的理解会改变一切——你如何与医生沟通、如何做出决定，以及你如何面对接下来的每一步。
    </p>
  </div>
</section>

<!-- How It Works -->
<section class="how-it-works" id="process">
  <div class="how-inner">
    <div class="how-header fade-in">
      <span class="section-label">使用体验</span>
      <h2>一眼就懂，需要时足够强大</h2>
    </div>

    <div class="how-content">
      <div class="mobile-mockup-wrapper fade-in">
        <div class="mobile-mockup">
          <div class="mobile-screen">
            <img
              src="/img/mobile-mocks/01-screen-records.png"
              alt="Mobile screen"
              class="mobile-screen-image active"
              data-step="0"
            />
            <img
              src="/img/mobile-mocks/02-screen-visit.png"
              alt="Mobile screen"
              class="mobile-screen-image"
              data-step="1"
            />
            <img
              src="/img/mobile-mocks/03-screen-plan.png"
              alt="Mobile screen"
              class="mobile-screen-image"
              data-step="2"
            />
          </div>
        </div>
      </div>

      <div class="steps">
        <div class="step fade-in" data-step-index="0">
          <span class="step-number">01</span>
          <div class="step-content">
            <h3>连接你的病历</h3>
            <p>
              从医院患者门户导入文件、由医生直接发送，或拍照上传——其余的交给我们。
            </p>
          </div>
        </div>

        <div class="step fade-in" data-step-index="1">
          <span class="step-number">02</span>
          <div class="step-content">
            <h3>聚焦真正重要的内容</h3>
            <p>
              查看关键发现、用药情况和下一步计划的清晰摘要。点击任何术语，即可通过可视化和解释深入了解。
            </p>
          </div>
        </div>

        <div class="step fade-in" data-step-index="2">
          <span class="step-number">03</span>
          <div class="step-content">
            <h3>始终走在正轨上</h3>
            <p>
              随访事项始终置顶，问题可随时保存。无论如何，你都能得到答案。
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Mobile Version: Steps with Individual Screen Images -->
    <div class="how-content-mobile">
      <div class="step-mobile fade-in">
        <div class="step-mobile-image-wrapper">
          <div class="step-mobile-image-container">
            <img
              src="/img/mobile-mocks/01-screen-records.png"
              alt="Connect your records"
              class="step-mobile-image"
            />
          </div>
        </div>
        <div class="step-mobile-content">
          <span class="step-mobile-number">01</span>
          <h3>连接你的病历</h3>
          <p>
            从医院患者门户导入文件、由医生直接发送，或拍照上传——其余的交给我们。
          </p>
        </div>
      </div>

      <div class="step-mobile fade-in">
        <div class="step-mobile-image-wrapper">
          <div class="step-mobile-image-container">
            <img
              src="/img/mobile-mocks/02-screen-visit.png"
              alt="See what matters"
              class="step-mobile-image"
            />
          </div>
        </div>
        <div class="step-mobile-content">
          <span class="step-mobile-number">02</span>
          <h3>聚焦真正重要的内容</h3>
          <p>
            查看关键发现、用药情况和下一步计划的清晰摘要。点击任何术语，即可通过可视化和解释深入了解。
          </p>
        </div>
      </div>

      <div class="step-mobile fade-in">
        <div class="step-mobile-image-wrapper">
          <div class="step-mobile-image-container">
            <img
              src="/img/mobile-mocks/03-screen-plan.png"
              alt="Stay on track"
              class="step-mobile-image"
            />
          </div>
        </div>
        <div class="step-mobile-content">
          <span class="step-mobile-number">03</span>
          <h3>始终走在正轨上</h3>
          <p>
            随访事项始终置顶，问题可随时保存。无论如何，你都能得到答案。
          </p>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- CTA -->
<section class="cta-section" id="signup">
  <div class="cta-inner fade-in">
    <h2>准备好真正理解你的健康了吗？</h2>
    <p>
      抢先体验 Obtego。加入等候名单，获取早期使用资格和最新动态。
    </p>

    <form class="email-form" id="email-form">
      <input type="email" placeholder="Enter your email" required />
      <button type="submit" class="btn-primary">获取早期体验资格</button>
    </form>
    <p class="form-note">
      我们只会在真正值得分享的时候联系你。
    </p>
  </div>
</section>

<!-- Footer -->
<footer>
  <div class="footer-logo">
    <a href="#" class="logo">
      <img src="/img/obtego-logomark.svg" alt="" />
      <span>obtego</span>
    </a>
  </div>
  <p>© 2025 Obtego 让医疗变得更有参与感</p>
</footer>

<!-- Video Modal -->
<div id="videoModal" class="video-modal">
  <div class="video-modal-overlay"></div>
  <div class="video-modal-content">
    <button class="video-modal-close" aria-label="Close modal">
      <svg
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M18 6L6 18M6 6L18 18"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
      </svg>
    </button>
    <div class="video-modal-iframe-wrapper">
      <iframe
        id="videoIframe"
        src=""
        frameborder="0"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
        allowfullscreen
      ></iframe>
    </div>
  </div>
</div>

<script>
  // Fade-in on scroll
  const fadeElements = document.querySelectorAll(".fade-in");
  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          entry.target.classList.add("visible");
        }
      });
    },
    { threshold: 0.1, rootMargin: "0px 0px -50px 0px" }
  );

  fadeElements.forEach((el) => observer.observe(el));

  // Form handling
  const emailForm = document.getElementById("email-form");
  if (emailForm) {
    emailForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const emailInput = emailForm.querySelector('input[type="email"]') as HTMLInputElement;
      const button = emailForm.querySelector("button") as HTMLButtonElement;
      const email = emailInput?.value;
      const originalButtonText = button?.innerHTML;

      if (!email || !button) return;

      // Disable button and show loading state
      button.disabled = true;
      button.innerHTML = "Submitting...";

      try {
        // Create FormData with email
        const formData = new FormData();
        formData.append("email", email);

        // Post to Google Apps Script
        await fetch(
          "https://script.google.com/macros/s/AKfycbwHEEbILn8rb5DOd9hMCUDEnRv2zhvItxOkBAf3n1NPplPPQJOwO9MaG68sctNkbPpf2Q/exec",
          {
            method: "POST",
            body: formData,
            mode: "no-cors", // Required for Google Apps Script
          }
        );

        // Success - update UI
        button.innerHTML = "Thank you! ✓";
        button.style.background = "var(--color-accent-hover)";
        emailInput.value = "";
      } catch (error) {
        // Error handling
        console.error("Error submitting form:", error);
        button.innerHTML = originalButtonText;
        button.disabled = false;
        alert("Something went wrong. Please try again.");
      }
    });
  }

  // Before/After Slider
  const sliderHandle = document.getElementById("sliderHandle");
  const sliderAfter = document.querySelector(".slider-after") as HTMLElement;
  const sliderContainer = document.querySelector(".slider-container") as HTMLElement;

  if (sliderHandle && sliderAfter && sliderContainer) {
    let isDragging = false;
    let rect: DOMRect | null = null;
    let rafId: number | null = null;

    function updateSlider(x: number) {
      if (!rect) {
        rect = sliderContainer.getBoundingClientRect();
      }
      const percentage = Math.max(
        0,
        Math.min(100, ((x - rect.left) / rect.width) * 100)
      );
      sliderAfter.style.clipPath = `inset(0 ${100 - percentage}% 0 0)`;
      sliderHandle!.style.left = `${percentage}%`;
    }

    function handleMove(e: MouseEvent | TouchEvent) {
      if (!isDragging) return;

      if (rafId) {
        cancelAnimationFrame(rafId);
      }

      rafId = requestAnimationFrame(() => {
        const clientX = "touches" in e ? e.touches[0].clientX : e.clientX;
        updateSlider(clientX);
      });
    }

    function startDrag(e: MouseEvent | TouchEvent) {
      isDragging = true;
      rect = sliderContainer.getBoundingClientRect();
      sliderContainer.classList.add("dragging");
      const clientX = "touches" in e ? e.touches[0].clientX : e.clientX;
      updateSlider(clientX);
    }

    function stopDrag() {
      isDragging = false;
      rect = null;
      sliderContainer.classList.remove("dragging");
      if (rafId) {
        cancelAnimationFrame(rafId);
        rafId = null;
      }
    }

    sliderHandle.addEventListener("mousedown", (e) => {
      e.preventDefault();
      startDrag(e);
    });

    sliderContainer.addEventListener("mousedown", (e) => {
      if (
        e.target === sliderContainer ||
        (e.target as HTMLElement).classList.contains("slider-image")
      ) {
        startDrag(e);
      }
    });

    document.addEventListener("mousemove", handleMove);
    document.addEventListener("mouseup", stopDrag);

    // Touch support
    sliderHandle.addEventListener("touchstart", (e) => {
      e.preventDefault();
      startDrag(e);
    });

    sliderContainer.addEventListener("touchstart", (e) => {
      if (
        e.target === sliderContainer ||
        (e.target as HTMLElement).classList.contains("slider-image")
      ) {
        startDrag(e);
      }
    });

    document.addEventListener("touchmove", handleMove, { passive: false });
    document.addEventListener("touchend", stopDrag);
  }

  // Hero Icon Cycling Animation
  const heroIcons = [
    document.querySelector(".hero-icon-schedule"),
    document.querySelector(".hero-icon-meds"),
    document.querySelector(".hero-icon-alerts"),
  ] as HTMLElement[];

  let currentActiveIcon = 0;

  function smoothScaleTransition(element: HTMLElement, targetScale: number, duration = 500) {
    const startScale = parseFloat(
      getComputedStyle(element).getPropertyValue("--icon-scale") || "1"
    );
    const startTime = performance.now();

    function animate(currentTime: number) {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);
      const eased = 1 - Math.pow(1 - progress, 3);
      const currentScale = startScale + (targetScale - startScale) * eased;

      element.style.setProperty("--icon-scale", currentScale.toString());

      if (progress < 1) {
        requestAnimationFrame(animate);
      }
    }

    requestAnimationFrame(animate);
  }

  function cycleHeroIcons() {
    heroIcons.forEach((icon, index) => {
      if (!icon) return;
      if (index === currentActiveIcon) {
        icon.classList.add("active");
        smoothScaleTransition(icon, 1.1);
      } else {
        icon.classList.remove("active");
        smoothScaleTransition(icon, 1);
      }
    });

    currentActiveIcon = (currentActiveIcon + 1) % heroIcons.length;
  }

  if (heroIcons[0]) {
    heroIcons[0].classList.add("active");
    heroIcons[0].style.setProperty("--icon-scale", "1.1");
  }

  setInterval(cycleHeroIcons, 2500);

  // Video Modal
  const videoModal = document.getElementById("videoModal");
  const videoModalTrigger = document.getElementById("videoModalTrigger");
  const videoModalClose = document.querySelector(".video-modal-close");
  const videoModalOverlay = document.querySelector(".video-modal-overlay");
  const videoIframe = document.getElementById("videoIframe") as HTMLIFrameElement;
  const youtubeVideoId = "wllRiJJSTpw";
  const youtubeEmbedUrl = `https://www.youtube.com/embed/${youtubeVideoId}?autoplay=1&enablejsapi=1`;

  function openVideoModal() {
    if (!videoModal || !videoIframe) return;
    videoModal.classList.add("active");
    videoIframe.src = youtubeEmbedUrl;
    document.body.style.overflow = "hidden";
  }

  function closeVideoModal() {
    if (!videoModal || !videoIframe) return;
    if (videoIframe.src) {
      videoIframe.contentWindow?.postMessage(
        '{"event":"command","func":"pauseVideo","args":""}',
        "*"
      );
    }
    videoModal.classList.remove("active");
    videoIframe.src = "";
    document.body.style.overflow = "";
  }

  videoModalTrigger?.addEventListener("click", (e) => {
    e.preventDefault();
    openVideoModal();
  });

  videoModalClose?.addEventListener("click", closeVideoModal);
  videoModalOverlay?.addEventListener("click", closeVideoModal);

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && videoModal?.classList.contains("active")) {
      closeVideoModal();
    }
  });

  // Step Click Handler for Mobile Mockup
  const steps = document.querySelectorAll(".step");
  const mobileImages = document.querySelectorAll(".mobile-screen-image");
  let currentActiveStep = 0;

  function switchToStep(stepIndex: number) {
    steps.forEach((step, index) => {
      if (index === stepIndex) {
        step.classList.add("active");
      } else {
        step.classList.remove("active");
      }
    });

    mobileImages.forEach((img, index) => {
      if (index === stepIndex) {
        img.classList.add("active");
      } else {
        img.classList.remove("active");
      }
    });

    currentActiveStep = stepIndex;
  }

  steps.forEach((step, index) => {
    step.addEventListener("click", () => {
      switchToStep(index);
    });
  });

  if (steps.length > 0) {
    switchToStep(0);
  }
</script>

